#include <stdbool.h>
#include <math.h>
#include "draw.h"
#include "monitor.h"
#include <avr/io.h>
#include "led.h"
#include "draw.h"
#include "figure.h"
#include "time.h"
#include "Ffloat.h"
#include "bluetooth.h"
#include <avr/interrupt.h>
#include <util/delay.h>

#define RETARD M_PI/10
#define DIVISOR 3

Figure m_shape;
float m_radius;

int last_angle = 3;

const char cinq[120][2] = {{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,128},{3,192},{6,192},{6,96},{12,32},{12,32},{8,64},{12,96},{12,224},{4,96},{4,32},{98,0},{98,0},{22,0},{28,0},{28,0},{16,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{16,0},{16,0},{16,0},{16,0},{97,0},{97,0},{7,128},{101,192},{109,192},{28,192},{16,192},{0,192},{0,192},{4,0},{4,128},{4,128},{15,128},{6,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{7,0},{5,128},{4,192},{4,192},{4,96},{8,32},{8,32},{4,0},{66,0},{98,0},{97,0},{66,0},{38,0},{38,0},{14,0},{12,0},{4,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{64,0},{64,0},{64,0},{64,0},{64,0},{0,0},{0,0},{4,0},{12,0},{28,0},{20,0},{33,0},{33,0},{33,128},{49,192},{50,192},{26,64},{28,64},{0,32},{0,32},{0,96},{0,192},{0,192},{1,128},{3,0},{0,0},{0,0},{0,0},{0,0},{0,0}};
const char deux[120][2] = {{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{3,0},{7,0},{5,128},{0,192},{0,192},{4,64},{31,96},{63,224},{62,96},{104,32},{96,0},{96,0},{96,0},{104,0},{40,0},{56,0},{24,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{16,0},{60,0},{124,0},{126,0},{4,0},{4,0},{12,0},{98,64},{2,192},{2,64},{4,64},{4,192},{4,192},{5,128},{7,0},{7,0},{12,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{2,0},{2,0},{15,128},{12,192},{12,192},{0,192},{0,192},{0,96},{0,224},{0,224},{3,192},{71,192},{127,192},{47,192},{36,128},{16,0},{16,0},{12,0},{12,0},{4,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{64,0},{64,0},{64,0},{64,0},{64,0},{0,0},{0,0},{4,0},{4,0},{12,0},{12,0},{20,0},{20,0},{36,32},{38,32},{44,32},{6,48},{6,112},{6,48},{6,48},{6,32},{6,32},{3,176},{3,240},{3,224},{1,128},{0,0},{0,0},{0,0},{0,0}};
const char huit[120][2] = {{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{1,128},{7,192},{14,192},{12,64},{12,192},{12,192},{12,64},{14,64},{60,192},{52,192},{100,192},{71,192},{71,192},{118,128},{124,0},{60,0},{28,0},{8,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{16,0},{60,0},{124,0},{124,0},{5,192},{5,192},{7,192},{127,192},{127,192},{126,64},{0,64},{24,192},{24,192},{12,64},{14,192},{14,192},{7,128},{2,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{3,128},{14,192},{12,64},{12,64},{12,64},{6,96},{6,224},{6,224},{116,192},{50,192},{99,192},{35,64},{102,0},{38,0},{38,0},{30,0},{30,0},{7,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{64,0},{64,0},{64,0},{64,0},{64,0},{0,0},{0,0},{2,0},{7,0},{31,0},{31,0},{32,0},{32,0},{33,224},{37,224},{63,224},{63,224},{61,224},{4,32},{4,32},{6,96},{6,64},{3,32},{3,96},{3,224},{1,128},{0,0},{0,0},{0,0},{0,0}};
const char neuf[120][2] = {{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,64},{1,192},{3,224},{14,32},{14,32},{60,0},{50,0},{98,0},{35,0},{99,0},{67,0},{67,0},{119,0},{127,0},{63,0},{30,0},{8,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{20,0},{63,0},{127,0},{127,0},{3,0},{3,0},{3,128},{99,128},{99,0},{122,128},{125,128},{9,0},{9,0},{1,128},{1,0},{1,0},{3,0},{6,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{3,128},{14,192},{12,64},{12,64},{12,64},{12,96},{24,224},{24,224},{24,64},{12,64},{12,192},{70,192},{71,192},{63,192},{63,192},{2,128},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{64,0},{64,0},{64,0},{64,0},{64,0},{0,0},{0,0},{0,0},{8,0},{16,0},{16,128},{19,192},{19,192},{23,224},{23,224},{28,224},{28,96},{24,96},{24,32},{24,32},{12,96},{14,64},{7,32},{3,96},{3,224},{1,128},{0,0},{0,0},{0,0},{0,0}};
const char quatre[120][2] = {{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{1,0},{3,0},{3,0},{6,0},{6,0},{14,0},{15,0},{29,0},{28,128},{56,128},{116,192},{116,192},{3,192},{1,64},{1,64},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{16,0},{16,0},{24,0},{28,0},{28,0},{14,128},{19,128},{19,0},{19,128},{19,128},{21,192},{21,192},{24,128},{16,0},{16,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,128},{1,192},{1,192},{3,192},{93,192},{93,192},{35,128},{19,128},{19,0},{11,0},{14,0},{28,0},{28,0},{10,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{64,0},{64,0},{64,0},{64,0},{64,0},{0,0},{1,0},{1,0},{1,0},{3,0},{3,128},{5,0},{5,0},{56,128},{28,128},{29,0},{30,128},{14,128},{6,0},{6,0},{3,128},{3,0},{1,128},{1,128},{1,0},{0,0},{0,0},{0,0},{0,0},{0,0}};
const char sept[120][2] = {{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,64},{0,96},{1,224},{1,224},{5,128},{7,128},{60,0},{52,0},{64,0},{96,0},{96,0},{16,0},{16,0},{16,0},{28,0},{24,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{16,0},{16,0},{28,0},{28,0},{20,0},{100,0},{100,0},{4,0},{2,0},{2,0},{98,0},{0,0},{2,0},{2,0},{2,0},{2,0},{2,0},{2,0},{6,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{8,0},{15,0},{9,128},{8,192},{8,192},{0,96},{0,48},{0,48},{0,192},{2,192},{3,192},{90,64},{116,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{64,0},{64,0},{64,0},{64,0},{64,0},{0,0},{0,0},{0,0},{8,0},{16,0},{24,0},{8,0},{8,0},{0,96},{4,32},{12,32},{6,48},{4,48},{4,48},{4,48},{6,96},{4,192},{2,192},{3,128},{7,0},{0,0},{0,0},{0,0},{0,0},{0,0}};
const char six[120][2] = {{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{1,128},{3,192},{6,192},{6,96},{12,32},{12,32},{24,64},{12,96},{28,224},{12,224},{8,224},{3,192},{3,192},{95,128},{31,0},{31,0},{6,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{32,0},{96,0},{96,0},{103,0},{103,0},{111,128},{105,192},{97,192},{120,192},{112,192},{24,192},{24,192},{12,64},{12,192},{12,192},{15,128},{6,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,128},{3,192},{7,64},{14,0},{14,0},{12,0},{26,0},{26,0},{115,0},{115,0},{99,0},{97,0},{67,0},{39,0},{39,0},{30,0},{28,0},{4,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{64,0},{64,0},{64,0},{64,0},{64,0},{0,0},{0,0},{6,0},{15,0},{31,0},{23,128},{33,192},{33,192},{33,192},{49,192},{48,192},{27,64},{31,64},{14,192},{14,192},{0,64},{0,192},{0,64},{0,0},{0,128},{1,128},{0,0},{0,0},{0,0},{0,0}};
const char trois[120][2] = {{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,128},{3,192},{6,192},{6,96},{12,32},{12,32},{8,64},{4,96},{60,224},{60,96},{108,96},{98,0},{98,0},{96,0},{104,0},{40,0},{24,0},{24,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{28,0},{28,0},{124,0},{5,0},{5,0},{15,128},{101,192},{13,192},{12,192},{0,192},{0,192},{0,192},{4,0},{12,128},{12,128},{15,128},{6,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{11,128},{12,128},{12,128},{0,192},{0,192},{0,64},{0,192},{0,192},{71,192},{99,192},{99,192},{96,64},{66,0},{38,0},{38,0},{14,0},{12,0},{4,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{64,0},{64,0},{64,0},{64,0},{64,0},{0,0},{0,0},{6,0},{14,0},{28,0},{20,0},{32,0},{32,0},{33,32},{49,32},{50,32},{26,48},{30,112},{6,48},{6,48},{6,32},{6,0},{3,160},{3,224},{1,224},{0,128},{0,0},{0,0},{0,0},{0,0}};
const char un[120][2] = {{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{1,128},{0,192},{1,192},{1,224},{3,32},{3,32},{7,0},{7,0},{14,0},{14,0},{28,0},{56,0},{56,0},{112,0},{80,0},{16,0},{16,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{96,0},{120,0},{120,0},{28,0},{14,0},{14,0},{7,0},{7,0},{3,0},{3,0},{1,192},{1,192},{1,192},{3,128},{6,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{1,128},{7,128},{1,128},{1,128},{1,128},{1,128},{3,0},{3,0},{7,0},{7,0},{14,0},{78,0},{92,0},{56,0},{56,0},{16,0},{16,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{64,0},{64,0},{64,0},{64,0},{64,0},{0,0},{0,0},{0,0},{8,0},{16,0},{16,0},{56,0},{56,0},{28,0},{14,0},{14,0},{7,0},{7,0},{3,32},{3,32},{1,224},{1,192},{0,192},{0,192},{0,192},{0,128},{0,0},{0,0},{0,0},{0,0}};
const char zero[120][2] = {{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{1,128},{3,192},{6,128},{14,0},{24,192},{24,192},{48,192},{48,192},{96,192},{32,192},{64,128},{65,192},{65,192},{127,128},{127,0},{63,0},{22,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{20,0},{63,0},{127,0},{119,128},{3,192},{3,192},{97,128},{96,192},{96,192},{112,192},{112,192},{24,192},{24,192},{14,64},{6,192},{6,192},{5,128},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{3,128},{6,192},{6,64},{14,64},{14,64},{12,96},{24,32},{24,32},{48,64},{16,64},{96,192},{48,192},{33,192},{35,192},{35,192},{31,128},{31,0},{5,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{64,0},{64,0},{64,0},{64,0},{64,0},{0,0},{0,0},{0,0},{5,0},{15,0},{15,128},{33,192},{33,192},{32,192},{48,192},{32,192},{16,64},{48,64},{24,224},{24,224},{12,96},{12,64},{6,32},{3,96},{3,224},{1,128},{0,0},{0,0},{0,0},{0,0}};


static char (*cadrans[4])[2] = {(char (*)[2])trois, (char (*)[2])trois, (char (*)[2])trois, (char (*)[2])trois};
int abs(int v){
  return (v >= 0)?v:-1*v;
}


char (*sym_to_a(char sym))[2]{
  switch (sym){
  case '0':
    return (char (*)[2]) zero;
  case '1':
    return (char (*)[2]) un;
  case '2':
    return (char (*)[2]) deux;
  case '3':
    return (char (*)[2]) trois;
  case '4':
    return (char (*)[2]) quatre;
  case '5':
    return (char (*)[2]) cinq;
  case '6':
    return (char (*)[2]) six;
  case '7':
    return (char (*)[2]) sept;
  case '8':
    return (char (*)[2]) huit;
  case '9':
  return (char (*)[2]) neuf;
    }
  return 0;
}

// 01:34
void update(char * t){
  if (time_has_changed()){
    cadrans[0] = sym_to_a(t[3]);
    cadrans[1] = sym_to_a(t[0]);
    cadrans[2] = sym_to_a(t[1]);
    cadrans[3] = sym_to_a(t[4]);
  }
}

void get_led_val(){  
  int alpha = get_current_angle();
  if (alpha == -1) return;
  if (last_angle != alpha){
    last_angle = alpha;
  }
  else
    return;
  alpha *= -1;
  alpha -= (90-RETARD); // led vers le haut par défaut
  while (alpha < 0)
    alpha = 360 + alpha;
  set_leds(cadrans[alpha/90][alpha/DIVISOR][0]
	   , cadrans[0][alpha/DIVISOR][1]);
}

void draw(){
  get_led_val();
}
